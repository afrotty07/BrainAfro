<!DOCTYPE html>
<html lang="ja">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>è„³å†…ã‚¢ãƒ•ãƒ­ãƒ¡ãƒ¼ã‚«ãƒ¼</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- FontAwesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Bangers&family=M+PLUS+Rounded+1c:wght@700&display=swap" rel="stylesheet">
    <style>
        /* ã‚«ã‚¹ã‚¿ãƒ ã‚¹ã‚¿ã‚¤ãƒ« */
        :root {
            --afro-black: #1a1a1a;
            --neon-pink: #ff00ff;
            --neon-green: #00ff00;
            --neon-yellow: #ffff00;
            --bg-color: #120f1f;
        }

        body {
            font-family: 'M PLUS Rounded 1c', sans-serif;
            background-color: var(--bg-color);
            background-image: 
                radial-gradient(circle at 10% 20%, rgba(255, 0, 255, 0.1) 0%, transparent 20%),
                radial-gradient(circle at 90% 80%, rgba(0, 255, 255, 0.1) 0%, transparent 20%);
            color: white;
            min-height: 100vh;
            overflow-x: hidden;
            ::-webkit-scrollbar { width: 8px; }
            ::-webkit-scrollbar-track { background: #1f2937; }
            ::-webkit-scrollbar-thumb { background: #4b5563; border-radius: 4px; }
            ::-webkit-scrollbar-thumb:hover { background: #6b7280; }
        }

        .funky-font {
            font-family: 'Bangers', cursive;
            letter-spacing: 2px;
        }

        /* ã‚¢ãƒ•ãƒ­è¡¨ç¤ºã‚¨ãƒªã‚¢ */
        .afro-stage {
            position: relative;
            width: 320px;
            height: 400px;
            margin: 0 auto;
            display: flex;
            justify-content: center;
            align-items: flex-end;
            z-index: 10;
        }

        /* é¡”ã‚³ãƒ³ãƒ†ãƒŠ */
        .face-container {
            width: 100px;
            height: 100px;
            background-color: transparent;
            border-radius: 50%;
            position: relative;
            z-index: 20;
            bottom: 30px;
            transition: border-color 0.3s ease, transform 0.3s ease;
            cursor: pointer;
            overflow: hidden;
            border: 2px solid rgba(255,255,255,0.2);
            box-shadow: 0 4px 10px rgba(0,0,0,0.5);
        }
        
        .face-container:hover {
            border-color: var(--neon-pink);
            box-shadow: 0 0 15px rgba(255,0,255,0.4);
        }

        .face-overlay {
            position: absolute;
            top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.5);
            display: flex; justify-content: center; align-items: center;
            opacity: 0; transition: opacity 0.3s;
            border-radius: 50%; z-index: 30; pointer-events: none;
        }

        .face-container:hover .face-overlay {
            opacity: 1;
        }

        .face-icon {
            font-size: 100px;
            color: #fcece2;
            filter: drop-shadow(0 4px 6px rgba(0,0,0,0.5));
            position: absolute;
            top: 50%; left: 50%;
            transform: translate(-50%, -50%);
        }

        /* åˆ‡ã‚ŠæŠœã‹ã‚ŒãŸç”»åƒã‚’è¡¨ç¤º */
        .face-image {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }
        
        /* ã‚¢ãƒ•ãƒ­æœ¬ä½“ */
        .afro-hair-container {
            position: absolute;
            bottom: 80px;
            left: 50%;
            transform: translateX(-50%);
            width: 300px;
            height: 300px;
            z-index: 15;
            animation: afro-bob 2s infinite ease-in-out alternate;
            pointer-events: none;
        }

        @keyframes afro-bob {
            0% { transform: translateX(-50%) translateY(0) scale(1); }
            100% { transform: translateX(-50%) translateY(-5px) scale(1.02); }
        }

        .afro-particle {
            position: absolute;
            border-radius: 50%;
            transition: all 0.5s ease;
            box-shadow: inset -2px -2px 4px rgba(0,0,0,0.3);
        }
        
        .afro-text-particle {
            display: flex; justify-content: center; align-items: center;
            font-size: 10px; font-weight: bold;
            color: rgba(255,255,255,0.9);
            text-shadow: 1px 1px 2px rgba(0,0,0,0.8);
            overflow: hidden; white-space: nowrap;
            z-index: 16;
        }

        .input-glass {
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
            box-shadow: 0 0 15px rgba(255, 0, 255, 0.2);
        }
        
        .input-glass:focus {
            box-shadow: 0 0 20px rgba(255, 0, 255, 0.6);
            border-color: var(--neon-pink);
            outline: none;
        }

        .btn-funky {
            background: linear-gradient(45deg, #ff00cc, #3333ff);
            border: none; position: relative; overflow: hidden;
            transition: transform 0.2s;
        }
        
        .btn-funky:hover {
            transform: scale(1.05);
            box-shadow: 0 0 20px rgba(255, 0, 204, 0.6);
        }

        .btn-funky::after {
            content: ''; position: absolute; top: -50%; left: -50%;
            width: 200%; height: 200%;
            background: linear-gradient(to bottom, rgba(255,255,255,0) 0%, rgba(255,255,255,0.3) 50%, rgba(255,255,255,0) 100%);
            transform: rotate(45deg); animation: shine 3s infinite;
        }

        @keyframes shine {
            0% { transform: translateX(-100%) rotate(45deg); }
            100% { transform: translateX(100%) rotate(45deg); }
        }

        .result-item {
            animation: slideIn 0.5s ease forwards;
            opacity: 0; transform: translateX(-20px);
        }

        @keyframes slideIn { to { opacity: 1; transform: translateX(0); } }
        
        .disco-ball { font-size: 3rem; animation: spin 2s linear infinite; }
        @keyframes spin { 100% { transform: rotate(360deg); } }

        .hidden-input { display: none; }

        /* ã‚¹ãƒ©ã‚¤ãƒ€ãƒ¼ */
        input[type=range] {
            -webkit-appearance: none; width: 100%; background: transparent;
        }
        input[type=range]::-webkit-slider-thumb {
            -webkit-appearance: none; height: 16px; width: 16px;
            border-radius: 50%; background: #ff00ff;
            cursor: pointer; margin-top: -6px;
            box-shadow: 0 0 5px rgba(255,0,255,0.8);
        }
        input[type=range]::-webkit-slider-runnable-track {
            width: 100%; height: 4px; cursor: pointer;
            background: rgba(255,255,255,0.3); border-radius: 2px;
        }
        input[type=range]:focus { outline: none; }

    </style>
</head>

<body class="flex flex-col items-center py-10 px-4">

    <!-- ã‚¿ã‚¤ãƒˆãƒ« -->
    <header class="mb-8 text-center relative">
        <h1 class="text-5xl md:text-7xl font-bold funky-font text-transparent bg-clip-text bg-gradient-to-r from-pink-500 via-yellow-400 to-blue-500 drop-shadow-[0_0_10px_rgba(255,0,255,0.5)]">
            BRAIN AFRO
        </h1>
        <p class="text-sm md:text-base text-gray-300 mt-2 tracking-widest">è„³å†…ã‚¢ãƒ•ãƒ­ãƒ¡ãƒ¼ã‚«ãƒ¼</p>
        <div class="absolute -top-10 -right-10 text-4xl animate-bounce">ğŸª©</div>
    </header>

    <!-- ãƒ¡ã‚¤ãƒ³ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ -->
    <main class="w-full max-w-4xl flex flex-col md:flex-row gap-8 items-start">
        
        <!-- å·¦å´: å…¥åŠ›ã¨ã‚¢ãƒ•ãƒ­è¡¨ç¤º -->
        <div class="flex-1 w-full flex flex-col items-center">
            
            <!-- å…¥åŠ›ãƒ•ã‚©ãƒ¼ãƒ  -->
            <div class="w-full max-w-sm mb-6 flex gap-2">
                <input type="text" id="nameInput" placeholder="åå‰ã‚’å…¥ã‚Œã¦ã­ (ä¾‹: ã‚¢ãƒ•ãƒ­ç”°ä¸­)" 
                    class="input-glass text-white px-4 py-3 rounded-l-full w-full text-lg placeholder-gray-400">
                <button onclick="analyzeAfro()" 
                    class="btn-funky text-white font-bold px-6 py-3 rounded-r-full text-lg whitespace-nowrap">
                    è¨ºæ–­!
                </button>
            </div>

            <!-- ã‚¢ãƒ•ãƒ­ã‚¹ãƒ†ãƒ¼ã‚¸ (Canvasã‚¨ãƒªã‚¢) -->
            <div id="captureArea" class="relative bg-gray-900/50 rounded-3xl p-4 border border-white/10 w-full max-w-sm flex flex-col items-center">
                <div class="absolute top-2 left-4 text-xs text-gray-500">BRAIN AFRO MAKER</div>
                
                <div class="afro-stage">
                    <!-- ã‚¢ãƒ•ãƒ­éƒ¨åˆ† (JSã§ç”Ÿæˆ) -->
                    <div id="afroContainer" class="afro-hair-container"></div>
                    
                    <!-- é¡”éƒ¨åˆ† -->
                    <div class="face-container" id="faceContainer" onclick="document.getElementById('faceUpload').click()" title="ã‚¯ãƒªãƒƒã‚¯ã—ã¦å†™çœŸã‚’å¤‰æ›´">
                        <!-- ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã‚¢ã‚¤ã‚³ãƒ³ -->
                        <i id="defaultFaceIcon" class="fa-solid fa-circle-user face-icon"></i>
                        <!-- ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ç”»åƒï¼ˆãƒˆãƒªãƒŸãƒ³ã‚°æ¸ˆã¿ï¼‰ -->
                        <img id="uploadedFaceImage" class="face-image hidden" src="" alt="Face">
                        
                        <!-- ãƒ›ãƒãƒ¼æ™‚ã®ã‚ªãƒ¼ãƒãƒ¼ãƒ¬ã‚¤ -->
                        <div class="face-overlay">
                            <i class="fa-solid fa-camera text-white text-2xl"></i>
                        </div>
                    </div>
                </div>

                <!-- éš ã—ãƒ•ã‚¡ã‚¤ãƒ«å…¥åŠ› -->
                <input type="file" id="faceUpload" class="hidden-input" accept="image/*">

                <!-- è£œåŠ©ãƒ†ã‚­ã‚¹ãƒˆ -->
                <p id="uploadHint" class="text-xs text-gray-500 mt-[-10px] mb-2 cursor-pointer hover:text-pink-400 transition" onclick="document.getElementById('faceUpload').click()">
                    <i class="fa-solid fa-camera"></i> å†™çœŸã‚’å¤‰æ›´ã™ã‚‹
                </p>

                <div id="userNameDisplay" class="text-xl font-bold mt-2 text-center text-pink-400 min-h-[1.75rem]"></div>
            </div>

            <!-- ã‚·ã‚§ã‚¢ãƒœã‚¿ãƒ³ç­‰ -->
            <div class="mt-6 flex gap-3 flex-wrap justify-center" id="actionButtons" style="display: none;">
                <button onclick="shareOnTwitter()" class="bg-black hover:bg-gray-800 text-white px-4 py-2 rounded-full border border-gray-700 transition flex items-center gap-2">
                    <i class="fa-brands fa-x-twitter"></i> ã‚·ã‚§ã‚¢
                </button>
                <button onclick="downloadImage()" class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-full transition flex items-center gap-2">
                    <i class="fa-solid fa-camera"></i> ä¿å­˜
                </button>
            </div>
        </div>

        <!-- å³å´: åˆ†æçµæœãƒªã‚¹ãƒˆ -->
        <div class="flex-1 w-full max-w-sm">
            <div class="bg-gray-800/60 backdrop-blur-md rounded-2xl p-6 border border-white/10 h-full">
                <h2 class="text-2xl font-bold mb-4 flex items-center gap-2 text-yellow-300">
                    <i class="fa-solid fa-chart-pie"></i> æˆåˆ†ãƒªã‚¹ãƒˆ
                </h2>
                
                <div id="loading" class="hidden flex justify-center items-center py-10">
                    <div class="disco-ball">ğŸª©</div>
                    <span class="ml-3 text-xl font-bold animate-pulse">Grooving...</span>
                </div>

                <div id="resultList" class="space-y-3">
                    <p class="text-gray-400 text-center py-10">
                        åå‰ã‚’å…¥åŠ›ã—ã¦ã€Œè¨ºæ–­!ã€ã‚’æŠ¼ã™ã¨<br>
                        ã‚ãªãŸã®ã‚¢ãƒ•ãƒ­æˆåˆ†ãŒè¡¨ç¤ºã•ã‚Œã¾ã™ã€‚
                    </p>
                </div>

                <div id="totalVolume" class="mt-6 pt-4 border-t border-gray-700 text-center hidden">
                    <p class="text-sm text-gray-400">TOTAL VOLUME</p>
                    <p class="text-4xl font-bold text-pink-500" id="volumeValue">0%</p>
                </div>
            </div>
        </div>
    </main>

    <!-- ãƒˆãƒªãƒŸãƒ³ã‚°ãƒ¢ãƒ¼ãƒ€ãƒ« -->
    <div id="cropModal" class="fixed inset-0 z-50 hidden flex items-center justify-center bg-black/90 backdrop-blur-sm p-4">
        <div class="bg-gray-800 p-6 rounded-2xl w-full max-w-md border border-white/10 shadow-2xl flex flex-col">
            <h3 class="text-xl font-bold mb-4 text-white text-center">å†™çœŸã®ä½ç½®ã‚’èª¿æ•´</h3>
            
            <p class="text-xs text-gray-400 text-center mb-2">ãƒ‰ãƒ©ãƒƒã‚°ã§ç§»å‹•ãƒ»ã‚¹ãƒ©ã‚¤ãƒ€ãƒ¼ã§æ‹¡å¤§ç¸®å°</p>

            <!-- ãƒˆãƒªãƒŸãƒ³ã‚°ã‚¨ãƒªã‚¢ -->
            <div class="relative w-full aspect-square bg-gray-900 rounded-lg overflow-hidden cursor-move touch-none border border-gray-700" id="cropAreaWrapper">
                <canvas id="cropCanvas" class="w-full h-full"></canvas>
                <!-- ã‚¬ã‚¤ãƒ‰ï¼ˆé»’ã„åŠé€æ˜ã®æ ã§ãƒã‚¹ã‚¯ã™ã‚‹ã‚¤ãƒ¡ãƒ¼ã‚¸ï¼‰ -->
                <div class="absolute inset-0 pointer-events-none" style="box-shadow: inset 0 0 0 9999px rgba(0,0,0,0.6);">
                    <!-- ä¸­å¤®ã®ç©´ï¼ˆå®Ÿéš›ã«ã¯ã“ã“ã ã‘box-shadowãŒã‹ã‹ã‚‰ãªã„ã‚ˆã†ã«è¦‹ã›ã‚‹ã®ã¯é›£ã—ã„ã®ã§ã€divã®æ§‹æˆã‚’å·¥å¤«ã™ã‚‹ï¼‰ -->
                </div>
                <!-- ç°¡æ˜“çš„ãªå††å½¢ã‚¬ã‚¤ãƒ‰ -->
                <div class="absolute inset-0 pointer-events-none flex items-center justify-center">
                    <div class="w-48 h-48 rounded-full border-2 border-pink-500 shadow-[0_0_0_9999px_rgba(0,0,0,0.7)]"></div>
                </div>
            </div>

            <!-- ã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ« -->
            <div class="mt-6 flex items-center gap-4">
                <i class="fa-solid fa-image text-xs text-gray-400"></i>
                <input type="range" id="cropZoom" min="0.1" max="3" step="0.01" value="1" class="flex-1">
                <i class="fa-solid fa-magnifying-glass-plus text-xs text-gray-400"></i>
            </div>

            <div class="mt-8 flex justify-end gap-3">
                <button onclick="closeCropModal()" class="px-4 py-2 rounded-full text-gray-300 hover:bg-gray-700 transition">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
                <button onclick="applyCrop()" class="px-6 py-2 rounded-full bg-gradient-to-r from-pink-500 to-purple-600 text-white font-bold hover:scale-105 transition shadow-lg">æ±ºå®š</button>
            </div>
        </div>
    </div>

    <footer class="mt-12 text-gray-500 text-xs text-center">
        <p>Â© 2024 Brain Afro Maker. All rights reserved.</p>
        <p class="mt-1">Powered by Tailwind & Funkiness</p>
    </footer>

    <!-- html2canvas (ç”»åƒä¿å­˜ç”¨) -->
    <script src="https://html2canvas.hertzen.com/dist/html2canvas.min.js"></script>

    <script>
        // --- è¨­å®šãƒ‡ãƒ¼ã‚¿ ---
        const AFRO_INGREDIENTS = [
            // åŸºæœ¬
            { name: "æ„›", color: "#ff69b4" },        // Pink
            { name: "ãƒ•ã‚¡ãƒ³ã‚¯", color: "#ffd700" },   // Gold
            { name: "é‡æœ›", color: "#ff4500" },      // OrangeRed
            { name: "è™šç„¡", color: "#a9a9a9" },      // DarkGray
            { name: "éŸ³æ¥½", color: "#00bfff" },      // DeepSkyBlue
            { name: "ç¡çœ ", color: "#9370db" },      // MediumPurple
            { name: "é‡‘", color: "#ffff00" },        // Yellow
            { name: "ç­‹è‚‰", color: "#cd5c5c" },      // IndianRed
            { name: "æ¨ã—", color: "#ff1493" },      // DeepPink
            { name: "å¯¿å¸", color: "#ff7f50" },      // Coral
            { name: "å®‡å®™", color: "#4b0082" },      // Indigo
            { name: "çŒ«", color: "#ffb6c1" },        // LightPink
            { name: "ãƒ©ãƒ¼ãƒ¡ãƒ³", color: "#f4a460" },  // SandyBrown
            { name: "ä¼‘æ—¥", color: "#98fb98" },      // PaleGreen
            { name: "ãƒªã‚ºãƒ ", color: "#00fa9a" },    // MediumSpringGreen
            { name: "çŸ¥æ€§", color: "#4682b4" },      // SteelBlue
            { name: "ç‹‚æ°—", color: "#dc143c" },      // Crimson
            { name: "ã‚½ã‚¦ãƒ«", color: "#8b4513" },    // SaddleBrown
            { name: "å¹³å’Œ", color: "#87ceeb" },      // SkyBlue
            { name: "æ¯’", color: "#9400d3" },        // DarkViolet
            
            // ã‚¢ãƒ•ãƒ­ & ãƒ˜ã‚¢é–¢é€£
            { name: "ç¸®æ¯›", color: "#000000" },      // Black
            { name: "æ¹¿æ°—", color: "#afeeee" },      // PaleTurquoise
            { name: "æ«›", color: "#deb887" },        // BurlyWood
            { name: "ãƒœãƒªãƒ¥ãƒ¼ãƒ ", color: "#ff00ff" }, // Magenta
            { name: "ãƒ‘ãƒ¼ãƒæ¶²", color: "#00ced1" },  // DarkTurquoise
            { name: "ã‚­ãƒ¥ãƒ¼ãƒ†ã‚£ã‚¯ãƒ«", color: "#e0ffff" }, // LightCyan
            { name: "ææ¯›", color: "#8b0000" },      // DarkRed
            { name: "é™é›»æ°—", color: "#ffffe0" },    // LightYellow

            // ãƒã‚¤ãƒ–ã‚¹ & çŠ¶æ…‹
            { name: "ã‚°ãƒ«ãƒ¼ãƒ´", color: "#da70d6" },  // Orchid
            { name: "ãƒ‡ã‚£ã‚¹ã‚³", color: "#c0c0c0" },  // Silver
            { name: "ã‚·ãƒ£ã‚¦ãƒˆ", color: "#ff4500" },  // OrangeRed
            { name: "ãƒ¢ã‚³ãƒ¢ã‚³", color: "#f5f5dc" },  // Beige
            { name: "ãƒ•ãƒ¯ãƒ•ãƒ¯", color: "#fff0f5" },  // LavenderBlush
            { name: "ãƒœãƒ³ãƒãƒ¼", color: "#ff8c00" },  // DarkOrange
            { name: "ã‚«ã‚ªã‚¹", color: "#2f4f4f" },    // DarkSlateGray
            { name: "é‡ç”Ÿ", color: "#228b22" },      // ForestGreen
            { name: "æƒ…ç†±", color: "#ff0000" },      // Red
            
            // ãã®ä»–ãƒ¦ãƒ‹ãƒ¼ã‚¯
            { name: "ã‚¿ãƒ”ã‚ªã‚«", color: "#d2691e" },  // Chocolate
            { name: "ãƒ—ãƒ­ãƒ†ã‚¤ãƒ³", color: "#f0e68c" },// Khaki
            { name: "Wi-Fi", color: "#000080" },     // Navy
            { name: "æœ‰çµ¦", color: "#7fffd4" },      // Aquamarine
            { name: "ã‚µã‚¦ãƒŠ", color: "#b22222" },    // FireBrick
            { name: "å”æšã’", color: "#d2b48c" },    // Tan
            { name: "å…‰", color: "#fffacd" },        // LemonChiffon
            { name: "é—‡", color: "#191970" },        // MidnightBlue
            { name: "æ¦‚å¿µ", color: "#778899" },      // LightSlateGray
            { name: "çˆ†ç™º", color: "#ff6347" },      // Tomato
            { name: "ãƒŸãƒ©ãƒ¼ãƒœãƒ¼ãƒ«", color: "#e6e6fa" } // Lavender
        ];

        let currentResults = [];
        let currentName = "";

        // ãƒˆãƒªãƒŸãƒ³ã‚°ç”¨ã‚¹ãƒ†ãƒ¼ãƒˆ
        let cropState = {
            img: null,
            scale: 1,
            x: 0,
            y: 0,
            isDragging: false,
            startX: 0,
            startY: 0,
            lastX: 0,
            lastY: 0
        };
        const cropCanvas = document.getElementById('cropCanvas');
        const cropCtx = cropCanvas.getContext('2d');

        // --- ã‚³ã‚¢ãƒ­ã‚¸ãƒƒã‚¯ ---

        function generateHash(str) {
            let hash = 0;
            for (let i = 0; i < str.length; i++) {
                const char = str.charCodeAt(i);
                hash = ((hash << 5) - hash) + char;
                hash = hash & hash;
            }
            return Math.abs(hash);
        }

        function mulberry32(a) {
            return function() {
                var t = a += 0x6D2B79F5;
                t = Math.imul(t ^ (t >>> 15), t | 1);
                t ^= t + Math.imul(t ^ (t >>> 7), t | 61);
                return ((t ^ (t >>> 14)) >>> 0) / 4294967296;
            }
        }

        function analyzeAfro() {
            const nameInput = document.getElementById('nameInput');
            const name = nameInput.value.trim();
            if (!name) {
                alert("åå‰ã‚’å…¥åŠ›ã—ã¦ã­ï¼");
                return;
            }

            currentName = name;
            document.getElementById('userNameDisplay').innerText = `Afro Type: ${name}`;
            document.getElementById('resultList').innerHTML = '';
            document.getElementById('afroContainer').innerHTML = '';
            document.getElementById('actionButtons').style.display = 'none';
            document.getElementById('totalVolume').classList.add('hidden');
            document.getElementById('loading').classList.remove('hidden');

            setTimeout(() => {
                performAnalysis(name);
                document.getElementById('loading').classList.add('hidden');
                document.getElementById('actionButtons').style.display = 'flex';
                document.getElementById('totalVolume').classList.remove('hidden');
            }, 800);
        }

        function performAnalysis(name) {
            const seed = generateHash(name);
            const rng = mulberry32(seed);

            const numIngredients = Math.floor(rng() * 4) + 3;
            let availableIngredients = [...AFRO_INGREDIENTS];
            
            for (let i = availableIngredients.length - 1; i > 0; i--) {
                const j = Math.floor(rng() * (i + 1));
                [availableIngredients[i], availableIngredients[j]] = [availableIngredients[j], availableIngredients[i]];
            }

            const selectedIngredients = availableIngredients.slice(0, numIngredients);
            
            let remaining = 100;
            let results = [];
            
            selectedIngredients.forEach((item, index) => {
                if (index === selectedIngredients.length - 1) {
                    results.push({ ...item, percentage: remaining });
                } else {
                    const max = remaining - (selectedIngredients.length - 1 - index) * 5; 
                    const val = Math.floor(rng() * (max * 0.6)) + 5;
                    results.push({ ...item, percentage: val });
                    remaining -= val;
                }
            });

            results.sort((a, b) => b.percentage - a.percentage);
            currentResults = results;

            const volume = Math.floor(rng() * 150) + 100;
            document.getElementById('volumeValue').innerText = `${volume}%`;

            renderResults(results);
            renderAfro(results, rng, volume);
        }

        function renderResults(results) {
            const container = document.getElementById('resultList');
            results.forEach((item, index) => {
                const el = document.createElement('div');
                el.className = 'result-item flex items-center justify-between bg-gray-700/50 p-2 rounded mb-2';
                el.style.animationDelay = `${index * 0.1}s`;
                el.innerHTML = `
                    <div class="flex items-center gap-3">
                        <div class="w-4 h-4 rounded-full shadow-[0_0_5px]" style="background-color: ${item.color}; box-shadow: 0 0 5px ${item.color}"></div>
                        <span class="font-bold text-lg">${item.name}</span>
                    </div>
                    <span class="font-mono text-xl text-white/90">${item.percentage}%</span>
                `;
                container.appendChild(el);
            });
        }

        function renderAfro(results, rng, volume) {
            const container = document.getElementById('afroContainer');
            const baseSize = 300;
            const centerX = baseSize / 2;
            const centerY = baseSize / 2;
            
            const maxRadius = (baseSize / 2) * (0.8 + (volume / 1000)); 
            const particleCount = 200 + Math.floor(volume * 0.5);

            let weightedPool = [];
            results.forEach(r => {
                for(let i=0; i<r.percentage; i++) {
                    weightedPool.push(r);
                }
            });

            for (let i = 0; i < particleCount; i++) {
                const item = weightedPool[Math.floor(rng() * weightedPool.length)];
                
                const angle = rng() * Math.PI * 2;
                const radius = Math.sqrt(rng()) * maxRadius * 0.9; 

                const x = centerX + Math.cos(angle) * radius;
                const y = centerY + Math.sin(angle) * radius;
                const size = 15 + rng() * 25;

                const el = document.createElement('div');
                el.classList.add('afro-particle');
                el.style.width = `${size}px`;
                el.style.height = `${size}px`;
                el.style.backgroundColor = item.color;
                el.style.left = `${x - size/2}px`;
                el.style.top = `${y - size/2}px`;
                el.style.zIndex = Math.floor(rng() * 50);
                
                if (size > 30 && rng() > 0.7) {
                    el.classList.add('afro-text-particle');
                    el.style.fontSize = `${size * 0.4}px`;
                    el.innerText = item.name;
                }

                container.appendChild(el);
            }

            for (let i=0; i<30; i++) {
                const angle = (i / 30) * Math.PI * 2;
                const radius = maxRadius * 0.85 + (rng() * 20);
                const x = centerX + Math.cos(angle) * radius;
                const y = centerY + Math.sin(angle) * radius;
                const size = 10 + rng() * 10;
                
                const item = weightedPool[Math.floor(rng() * weightedPool.length)];
                
                const el = document.createElement('div');
                el.classList.add('afro-particle');
                el.style.width = `${size}px`;
                el.style.height = `${size}px`;
                el.style.backgroundColor = item.color;
                el.style.left = `${x - size/2}px`;
                el.style.top = `${y - size/2}px`;
                container.appendChild(el);
            }
        }

        // --- ç”»åƒå‡¦ç†ãƒ»ãƒˆãƒªãƒŸãƒ³ã‚°ãƒ­ã‚¸ãƒƒã‚¯ ---

        // ãƒ•ã‚¡ã‚¤ãƒ«ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰é–‹å§‹
        document.getElementById('faceUpload').addEventListener('change', function(e) {
            const file = e.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = function(event) {
                    const img = new Image();
                    img.onload = function() {
                        openCropModal(img);
                    };
                    img.src = event.target.result;
                };
                reader.readAsDataURL(file);
            }
            // åŒã˜ãƒ•ã‚¡ã‚¤ãƒ«ã‚’é¸ã¹ã‚‹ã‚ˆã†ã«ãƒªã‚»ãƒƒãƒˆ
            e.target.value = '';
        });

        // ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’é–‹ã
        function openCropModal(img) {
            cropState.img = img;
            cropState.scale = 1;
            cropState.x = 0;
            cropState.y = 0;
            cropState.lastX = 0;
            cropState.lastY = 0;
            
            // ãƒ¢ãƒ¼ãƒ€ãƒ«è¡¨ç¤º
            document.getElementById('cropModal').classList.remove('hidden');
            
            // ã‚¹ãƒ©ã‚¤ãƒ€ãƒ¼ãƒªã‚»ãƒƒãƒˆ
            document.getElementById('cropZoom').value = 1;

            // Canvasã‚µã‚¤ã‚ºåˆæœŸåŒ–ï¼ˆã‚³ãƒ³ãƒ†ãƒŠã‚µã‚¤ã‚ºã«åˆã‚ã›ã‚‹ï¼‰
            const wrapper = document.getElementById('cropAreaWrapper');
            cropCanvas.width = wrapper.clientWidth;
            cropCanvas.height = wrapper.clientHeight;

            // åˆæœŸä½ç½®ï¼šç”»åƒã‚’ä¸­å¿ƒã«åˆã‚ã›ã‚‹ã€ã‚µã‚¤ã‚ºã¯çŸ­è¾ºã‚’Canvasã«åˆã‚ã›ã‚‹
            const ratio = Math.min(cropCanvas.width / img.width, cropCanvas.height / img.height);
            // æœ€åˆã¯å°‘ã—å¤§ãã‚ã«è¡¨ç¤ºã—ã¦æ ã‚’åŸ‹ã‚ã‚‹
            cropState.scale = ratio * 1.2; 
            document.getElementById('cropZoom').value = cropState.scale;
            
            drawCropCanvas();
        }

        // ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’é–‰ã˜ã‚‹
        function closeCropModal() {
            document.getElementById('cropModal').classList.add('hidden');
        }

        // Canvasæç”»
        function drawCropCanvas() {
            if (!cropState.img) return;

            cropCtx.clearRect(0, 0, cropCanvas.width, cropCanvas.height);
            
            cropCtx.save();
            cropCtx.translate(cropCanvas.width / 2, cropCanvas.height / 2);
            cropCtx.translate(cropState.x, cropState.y);
            cropCtx.scale(cropState.scale, cropState.scale);
            cropCtx.drawImage(cropState.img, -cropState.img.width / 2, -cropState.img.height / 2);
            cropCtx.restore();
        }

        // ã‚ºãƒ¼ãƒ æ“ä½œ
        document.getElementById('cropZoom').addEventListener('input', function(e) {
            cropState.scale = parseFloat(e.target.value);
            drawCropCanvas();
        });

        // ãƒ‰ãƒ©ãƒƒã‚°æ“ä½œ
        const cropArea = document.getElementById('cropAreaWrapper');
        
        cropArea.addEventListener('mousedown', startCropDrag);
        cropArea.addEventListener('touchstart', startCropDrag, {passive: false});

        window.addEventListener('mousemove', doCropDrag);
        window.addEventListener('touchmove', doCropDrag, {passive: false});

        window.addEventListener('mouseup', endCropDrag);
        window.addEventListener('touchend', endCropDrag);

        function startCropDrag(e) {
            e.preventDefault();
            cropState.isDragging = true;
            const clientX = e.type.includes('touch') ? e.touches[0].clientX : e.clientX;
            const clientY = e.type.includes('touch') ? e.touches[0].clientY : e.clientY;
            cropState.startX = clientX;
            cropState.startY = clientY;
            cropState.lastX = cropState.x;
            cropState.lastY = cropState.y;
        }

        function doCropDrag(e) {
            if (!cropState.isDragging) return;
            e.preventDefault();
            const clientX = e.type.includes('touch') ? e.touches[0].clientX : e.clientX;
            const clientY = e.type.includes('touch') ? e.touches[0].clientY : e.clientY;
            
            const dx = clientX - cropState.startX;
            const dy = clientY - cropState.startY;

            cropState.x = cropState.lastX + dx;
            cropState.y = cropState.lastY + dy;
            
            drawCropCanvas();
        }

        function endCropDrag() {
            cropState.isDragging = false;
        }

        // åˆ‡ã‚ŠæŠœãé©ç”¨
        function applyCrop() {
            if (!cropState.img) return;

            // åˆ‡ã‚ŠæŠœãç”¨ã®ã‚ªãƒ•ã‚¹ã‚¯ãƒªãƒ¼ãƒ³Canvas
            const size = 300; // å‡ºåŠ›è§£åƒåº¦
            const outputCanvas = document.createElement('canvas');
            outputCanvas.width = size;
            outputCanvas.height = size;
            const ctx = outputCanvas.getContext('2d');

            // å††å½¢ã‚¯ãƒªãƒƒãƒ—
            ctx.beginPath();
            ctx.arc(size/2, size/2, size/2, 0, Math.PI * 2);
            ctx.clip();

            // æç”»ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã®è¨ˆç®—
            // ãƒ¢ãƒ¼ãƒ€ãƒ«ä¸Šã®Canvasã®ä¸­å¿ƒ(width/2, height/2)ã«ã‚ã‚‹ã‚‚ã®ãŒã€å‡ºåŠ›ã®ä¸­å¿ƒ(size/2, size/2)ã«æ¥ã‚‹
            // ãƒ¢ãƒ¼ãƒ€ãƒ«ä¸Šã®ã‚¹ã‚±ãƒ¼ãƒ«ã¨å‡ºåŠ›ã‚¹ã‚±ãƒ¼ãƒ«ã®æ¯”ç‡ã‚’è€ƒæ…®ã™ã‚‹å¿…è¦ãŒã‚ã‚‹ãŒã€
            // ã“ã“ã§ã¯ç°¡æ˜“çš„ã«ã€Œè¦‹ãŸç›®ã®ä¸­å¿ƒã«ã‚ã‚‹ã‚‚ã®ã€ã‚’å–å¾—ã™ã‚‹è¨ˆç®—ã‚’è¡Œã†

            // ãƒ¢ãƒ¼ãƒ€ãƒ«ã®å††ï¼ˆç›´å¾„192px = 12remï¼‰ã¨Canvasã®é–¢ä¿‚
            // CSSã§å††ã¯ w-48 h-48 (192px)
            // Canvaså…¨ä½“ã«å¯¾ã™ã‚‹æ¯”ç‡ã‚’è¨ˆç®—ã™ã‚‹
            
            // ã‚·ãƒ³ãƒ—ãƒ«ãªã‚¢ãƒ—ãƒ­ãƒ¼ãƒ:
            // cropCanvasã®ä¸­å¿ƒåº§æ¨™ã‚’åŸºæº–ã«ã€cropState.x, y, scaleã‚’ä½¿ã£ã¦æç”»
            // ãŸã ã—ã€å‡ºåŠ›Canvasã®ã‚µã‚¤ã‚º(300)ã«åˆã‚ã›ã¦ã‚¹ã‚±ãƒ¼ãƒªãƒ³ã‚°ã™ã‚‹
            
            // ãƒ¢ãƒ¼ãƒ€ãƒ«ä¸Šã®å††ã®ç›´å¾„(px)
            const guideDiameter = 192; 
            // å‡ºåŠ›ã‚µã‚¤ã‚ºã¨ã®å€ç‡
            const outputScaleFactor = size / guideDiameter;

            ctx.translate(size/2, size/2);
            // ç§»å‹•é‡ã‚‚å€ç‡ã«åˆã‚ã›ã‚‹
            ctx.translate(cropState.x * outputScaleFactor, cropState.y * outputScaleFactor);
            // ã‚¹ã‚±ãƒ¼ãƒ«ã‚‚åˆã‚ã›ã‚‹
            const finalScale = cropState.scale * outputScaleFactor;
            ctx.scale(finalScale, finalScale);
            
            ctx.drawImage(cropState.img, -cropState.img.width/2, -cropState.img.height/2);

            // é©ç”¨
            const dataUrl = outputCanvas.toDataURL('image/png');
            const imgEl = document.getElementById('uploadedFaceImage');
            const iconEl = document.getElementById('defaultFaceIcon');
            
            imgEl.src = dataUrl;
            imgEl.classList.remove('hidden');
            iconEl.classList.add('hidden');
            
            // é–‰ã˜ã‚‹
            closeCropModal();
        }


        // --- ãã®ä»–æ©Ÿèƒ½ ---

        function shareOnTwitter() {
            if (!currentResults || currentResults.length === 0) return;

            const top3 = currentResults.slice(0, 3).map(r => `${r.name}`).join('ãƒ»');
            const volume = document.getElementById('volumeValue').innerText;
            
            const text = `ã€${currentName}ã®ã‚¢ãƒ•ãƒ­è¨ºæ–­çµæœã€‘\n\nãƒœãƒªãƒ¥ãƒ¼ãƒ : ${volume}\næˆåˆ†: ${top3} ãªã©\n\nã‚ãªãŸã®ã‚¢ãƒ•ãƒ­ã«ã¯${currentResults[0].name}ãŒè©°ã¾ã£ã¦ã„ã¾ã™ï¼\n\n#è„³å†…ã‚¢ãƒ•ãƒ­ãƒ¡ãƒ¼ã‚«ãƒ¼ #BrainAfro \n`;
            const url = window.location.href; 

            const tweetUrl = `https://twitter.com/intent/tweet?text=${encodeURIComponent(text)}&url=${encodeURIComponent(url)}`;
            window.open(tweetUrl, '_blank');
        }

        function downloadImage() {
            const captureArea = document.getElementById('captureArea');
            html2canvas(captureArea, {
                backgroundColor: '#1f2937', 
                scale: 2, 
                logging: false,
                useCORS: true,
                allowTaint: true 
            }).then(canvas => {
                const link = document.createElement('a');
                link.download = `${currentName}_afro.png`;
                link.href = canvas.toDataURL('image/png');
                link.click();
            });
        }
        
        document.getElementById('nameInput').addEventListener('keypress', function (e) {
            if (e.key === 'Enter') {
                analyzeAfro();
            }
        });
    </script>
</body>
</html>
